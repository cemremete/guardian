stages:
  - test
  - build
  - deploy

variables:
  DOCKER_DRIVER: overlay2
  DOCKER_TLS_CERTDIR: ""

# cache node_modules between jobs
cache:
  paths:
    - backend/node_modules/
    - ml-audit/.venv/

# backend tests
test-backend:
  stage: test
  image: node:20-alpine
  script:
    - cd backend
    - npm ci
    - npm run lint || true  # don't fail on lint warnings for now
    - npm test
  only:
    - main
    - merge_requests

# python tests
test-ml-audit:
  stage: test
  image: python:3.11-slim
  script:
    - cd ml-audit
    - pip install -r requirements.txt
    - python -m pytest tests/ -v || echo "No tests yet"
  only:
    - main
    - merge_requests

# build docker images
build-backend:
  stage: build
  image: docker:24
  services:
    - docker:24-dind
  script:
    - docker build -f docker/backend.Dockerfile -t guardian-backend:$CI_COMMIT_SHA .
    - docker tag guardian-backend:$CI_COMMIT_SHA guardian-backend:latest
    # push to registry if configured
    # - docker push $CI_REGISTRY_IMAGE/backend:$CI_COMMIT_SHA
  only:
    - main

build-ml-audit:
  stage: build
  image: docker:24
  services:
    - docker:24-dind
  script:
    - docker build -f docker/ml-audit.Dockerfile -t guardian-ml-audit:$CI_COMMIT_SHA .
    - docker tag guardian-ml-audit:$CI_COMMIT_SHA guardian-ml-audit:latest
  only:
    - main

build-frontend:
  stage: build
  image: docker:24
  services:
    - docker:24-dind
  script:
    - docker build -f docker/frontend.Dockerfile -t guardian-frontend:$CI_COMMIT_SHA .
    - docker tag guardian-frontend:$CI_COMMIT_SHA guardian-frontend:latest
  only:
    - main

# deploy to staging
deploy-staging:
  stage: deploy
  image: alpine:latest
  before_script:
    - apk add --no-cache openssh-client
    - eval $(ssh-agent -s)
    - echo "$SSH_PRIVATE_KEY" | tr -d '\r' | ssh-add -
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
  script:
    - echo "Deploying to staging..."
    # add your deployment commands here
    # ssh user@staging-server "cd /opt/guardian && docker-compose pull && docker-compose up -d"
  environment:
    name: staging
    url: https://staging.guardian.cern.ch
  only:
    - main
  when: manual

# deploy to production
deploy-production:
  stage: deploy
  image: alpine:latest
  before_script:
    - apk add --no-cache openssh-client
    - eval $(ssh-agent -s)
    - echo "$SSH_PRIVATE_KEY" | tr -d '\r' | ssh-add -
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
  script:
    - echo "Deploying to production..."
    # ssh user@prod-server "cd /opt/guardian && docker-compose pull && docker-compose up -d"
  environment:
    name: production
    url: https://guardian.cern.ch
  only:
    - main
  when: manual
  needs:
    - deploy-staging
